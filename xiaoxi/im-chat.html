<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<link rel="stylesheet" href="../css/base-reset.css">
		<link rel="stylesheet" href="../css/mui.min.css">
		<link rel="stylesheet" type="text/css" href="../css/common.css">
		<link href="../css/mui.imageviewer.css" rel="stylesheet" />
		<link rel="stylesheet" href="../css/ww.css" />
		<style>
			html,
			body {
				height: 100%;
				margin: 0px;
				padding: 0px;
				overflow: hidden;
				-webkit-touch-callout: none;
				-webkit-user-select: none;
			}
			
			footer {
				position: fixed;
				width: 100%;
				height: 50px;
				min-height: 50px;
				border-top: solid 1px #bbb;
				left: 0px;
				bottom: 0px;
				overflow: hidden;
				padding: 0px 50px 0 50px;
				background-color: #fafafa;
			}
			
			.footer-left {
				position: absolute;
				width: 10px;
				height: 50px;
				left: 0px;
				bottom: 0px;
				text-align: center;
				vertical-align: middle;
				line-height: 100%;
				padding: 12px 12px;
			}
			
			.footer-right {
				position: absolute;
				width: 50px;
				height: 50px;
				right: 0px;
				bottom: 0px;
				text-align: center;
				vertical-align: middle;
				line-height: 100%;
				padding: 12px 5px;
				display: inline-block;
			}
			
			.footer-center {
				height: 100%;
				padding: 5px 0px;
			}
			
			.footer-center [class*=input] {
				width: 100%;
				height: 100%;
				border-radius: 5px;
			}
			
			.footer-center .input-text {
				background: #fff;
				border: solid 1px #ddd;
				padding: 10px !important;
				font-size: 16px !important;
				line-height: 18px !important;
				font-family: verdana !important;
				overflow: hidden;
			}
			
			.footer-center .input-sound {
				background-color: #eee;
			}
			
			.mui-content {
				height: 100%;
				padding: 44px 0px 50px 0px;
				overflow: auto;
				background-color: #EFEEF3;
			}
			
			#msg-list {
				height: 100%;
				overflow: auto;
				-webkit-overflow-scrolling: touch;
			}
			
			.msg-item {
				padding: 8px;
				clear: both;
			}
			
			.msg-item .mui-item-clear {
				clear: both;
			}
			
			.msg-item .msg-user {
				width: 38px;
				height: 38px;
				border: solid 1px #d3d3d3;
				display: inline-block;
				background: #fff;
				border-radius: 3px;
				vertical-align: top;
				text-align: center;
				float: left;
				padding: 3px;
				color: #ddd;
			}
			
			.msg-item .msg-user-img {
				width: 38px;
				height: 38px;
				display: inline-block;
				border-radius: 3px;
				vertical-align: top;
				text-align: center;
				float: left;
				color: #ddd;
			}
			
			.msg-item .msg-content {
				display: inline-block;
				border-radius: 5px;
				border: solid 1px #d3d3d3;
				background-color: #FFFFFF;
				color: #333;
				padding: 8px;
				vertical-align: top;
				font-size: 15px;
				position: relative;
				margin: 0px 8px;
				max-width: 75%;
				min-width: 35px;
				float: left;
			}
			
			.msg-item .msg-content .msg-content-inner {
				overflow-x: hidden;
			}
			
			.msg-item .msg-content .msg-content-arrow {
				position: absolute;
				border: solid 1px #d3d3d3;
				border-right: none;
				border-top: none;
				background-color: #FFFFFF;
				width: 10px;
				height: 10px;
				left: -5px;
				top: 12px;
				-webkit-transform: rotateZ(45deg);
				transform: rotateZ(45deg);
			}
			
			.msgItemSelf .msg-user,
			.msgItemSelf .msg-content {
				float: right;
			}
			
			.msgItemSelf .msg-content .msg-content-arrow {
				left: auto;
				right: -5px;
				-webkit-transform: rotateZ(225deg);
				transform: rotateZ(225deg);
			}
			
			.msgItemSelf .msg-content,
			.msgItemSelf .msg-content .msg-content-arrow {
				background-color: #4CD964;
				color: #fff;
				border-color: #2AC845;
			}
			
			footer .mui-icon {
				color: #000;
			}
			
			footer .mui-icon:active {
				color: #007AFF !important;
			}
			
			footer .mui-icon-paperplane:before {
				content: "发送";
			}
			
			footer .mui-icon-paperplane {
				/*-webkit-transform: rotateZ(45deg);
				transform: rotateZ(45deg);*/
				font-size: 16px;
				word-break: keep-all;
				line-height: 100%;
				padding-top: 6px;
				color: rgba(0, 135, 250, 1);
			}
			
			footer .mui-icon-plus,
			.mui-icon-close {
				font-size: 28px;
			}
			
			#msg-sound {
				-webkit-user-select: none !important;
				user-select: none !important;
			}
			
			.rprogress {
				position: absolute;
				left: 50%;
				top: 50%;
				width: 140px;
				height: 140px;
				margin-left: -70px;
				margin-top: -70px;
				background-image: url(../images/arecord.png);
				background-repeat: no-repeat;
				background-position: center center;
				background-size: 30px 30px;
				background-color: rgba(0, 0, 0, 0.7);
				border-radius: 5px;
				display: none;
				-webkit-transition: .15s;
			}
			
			.rschedule {
				background-color: rgba(0, 0, 0, 0);
				border: 5px solid rgba(0, 183, 229, 0.9);
				opacity: .9;
				border-left: 5px solid rgba(0, 0, 0, 0);
				border-right: 5px solid rgba(0, 0, 0, 0);
				border-radius: 50px;
				box-shadow: 0 0 15px #2187e7;
				width: 46px;
				height: 46px;
				position: absolute;
				left: 50%;
				top: 50%;
				margin-left: -23px;
				margin-top: -23px;
				-webkit-animation: spin 1s infinite linear;
				animation: spin 1s infinite linear;
			}
			
			.r-sigh {
				display: none;
				border-radius: 50px;
				box-shadow: 0 0 15px #2187e7;
				width: 46px;
				height: 46px;
				position: absolute;
				left: 50%;
				top: 50%;
				margin-left: -23px;
				margin-top: -23px;
				text-align: center;
				line-height: 46px;
				font-size: 40px;
				font-weight: bold;
				color: #2187e7;
			}
			
			.rprogress-sigh {
				background-image: none !important;
			}
			
			.rprogress-sigh .rschedule {
				display: none !important;
			}
			
			.rprogress-sigh .r-sigh {
				display: block !important;
			}
			
			.rsalert {
				font-size: 12px;
				color: #bbb;
				text-align: center;
				position: absolute;
				border-radius: 5px;
				width: 130px;
				margin: 5px 5px;
				padding: 5px;
				left: 0px;
				bottom: 0px;
			}
			
			@-webkit-keyframes spin {
				0% {
					-webkit-transform: rotate(0deg);
				}
				100% {
					-webkit-transform: rotate(360deg);
				}
			}
			
			@keyframes spin {
				0% {
					transform: rotate(0deg);
				}
				100% {
					transform: rotate(360deg);
				}
			}
			
			#h {
				background: #fff;
				border: solid 1px #ddd;
				padding: 10px !important;
				font-size: 16px !important;
				font-family: verdana !important;
				line-height: 18px !important;
				overflow: visible;
				position: absolute;
				left: -1000px;
				right: 0px;
				word-break: break-all;
				word-wrap: break-word;
			}
			
			.cancel {
				background-color: darkred;
			}
			
			.addBox {
				position: fixed;
				bottom: 0px;
				left: 0px;
				z-index: 1;
				background-color: #EFEEF3;
				height: 120px;
				width: 100%;
			}
			
			.addBox div {
				float: left;
				text-align: center;
				margin-left: 10px;
				width: 60px;
				margin-top: 20px;
				color: #AAAAAA;
			}
			
			.addBox img {
				font-size: 40px;
				display: block;
				background-color: white;
				margin: 7px auto;
			}
		</style>
	</head>

	<body>
		<div class="mui-bar mui-bar-nav header project-list-head" style="height: 50px;line-height: 50px;">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" style="font-size: 1.8rem;"></a>
			<span style="font-size: 1rem !important;">im-chat</span>
		</div>
		<pre id='h'></pre>
		<div id="chatList" class="mui-content" style="margin-top: 10px;">
			<div id='msg-list'>
				<!---bind="{msgItemSelf:item.empId==empId}"-->
				<div v-for="item in dataArr" v-bind:class="{msgItemSelf:item.empId==empId}" class="msg-item" msg-type='{{item.msgType}}' msg-content='{{item.content}}'>
					<i v-if="item.empId==empId" class="msg-user mui-icon mui-icon-person"></i>
					<img v-if="item.empId!=empId" class="msg-user-img" src="{{item.logo}}" alt="{{item.logo}}" />
					<div class="msg-content">
						<div class="msg-content-inner">
							<template v-if="item.msgType=='10'">
								{{item.content}}
								<span v-if="item.content == null || item.content == ''">&nbsp;&nbsp;</span>
							</template>
							<template v-else>
								<template v-if="item.msgType=='30'">
									<img class="msg-content-image" src="{{item.content}}" style="max-width: 100px;" />
								</template>
								<template v-else>
									<span class="mui-icon mui-icon-mic" style="font-size: 18px;font-weight: bold;"></span>
									<span class="play-state">点击播放</span>
								</template>
							</template>
						</div>
						<div class="msg-content-arrow"></div>
					</div>
					<div class="mui-item-clear"></div>
				</div>
			</div>
		</div>
		<footer>
			<div class="footer-left">
				<i id='msg-speech' class="mui-icon mui-icon-mic"></i>
			</div>
			<div class="footer-center">
				<textarea id='msg-text' type="text" class='input-text'></textarea>
				<button id='msg-sound' type="button" class='input-sound' style="display: none;">按住说话</button>
			</div>
			<label for="" class="footer-right">
				<i id='msg-type'  class="mui-icon mui-icon-plus"></i>
			</label>
		</footer>
		<div id='sound-alert' class="rprogress">
			<div class="rschedule"></div>
			<div class="r-sigh">!</div>
			<div id="audio_tips" class="rsalert">手指上滑，取消发送</div>
		</div>
		<div id="addBox" class="addBox" style="display: none;">
			<div>
				<img id="galleryBtn" src="images/icon-oa-check.png" />相册
			</div>
			<div>
				<img id="cameraBtn" src="images/icon-oa-check.png" />拍照
			</div>
		</div>

		<script src="../js/mui.min.js"></script>
		<script src="../js/mui.imageViewer.js"></script>
		<script src="../js/arttmpl.js"></script>
		<script type="text/javascript" src="../js/vue.min.js"></script>
		<script type="text/javascript" src="../js/global.js"></script>
		<script type="text/javascript" src="../js/public.js"></script>
		<script type="text/javascript" src="../js/zepto1.1.6.min.js"></script>
		<script type="text/javascript" charset="utf-8">
			(function(mui, doc) {
				var chatListVM = new Vue({
					el: '#chatList',
					data: {
						dataArr: [],
						empId: "",
						groupId: ""
					},
					ready: function() {
						this.empId = localStorage.empId;
						this.groupId = localStorage.groupId;
					}
				});
				var ui = {
					body: doc.querySelector('body'),
					footer: doc.querySelector('footer'),
					buttonSpeech: doc.querySelector('.footer-left'),
					buttonAdd: doc.querySelector('.footer-right'),
					btnMsgType: doc.querySelector('#msg-type'), //输入类型
					boxMsgText: doc.querySelector('#msg-text'), //文本输入框
					btnMsgSpeech: doc.querySelector('#msg-speech'),
					boxMsgSound: doc.querySelector('#msg-sound'),
					areaMsgList: doc.querySelector('#msg-list'), //信息列表
					boxSoundAlert: doc.querySelector('#sound-alert'), //语音提示
					addBox: doc.querySelector('#addBox'),
					cameraBtn: doc.querySelector('#cameraBtn'),
					galleryBtn: doc.querySelector('#galleryBtn'),
					h: doc.querySelector('#h'), //输入框 多行显示
					content: doc.querySelector('.mui-content')
				};

				var MIN_SOUND_TIME = 800;
				mui.init({
					gestureConfig: {
						tap: true, //默认为true
						doubletap: true, //默认为false
						longtap: true, //默认为false
						swipe: true, //默认为true
						drag: true, //默认为true
						hold: true, //默认为false，不监听
						release: true //默认为false，不监听
					}
				});
				template.config('escape', false);
				//mui.plusReady=function(fn){fn();};
				mui.plusReady(function() {
					var record = [];

					var queryMsg = function getChaList() {
						mui.ajax(getBaseServerUrl() + '/app/chatGroup/getChatGroupMsgList', {
							type: 'get', //HTTP请求类型
							data: {
								empId: chatListVM.empId,
								groupId: chatListVM.groupId
							},
							success: function(jsonData) {
								for(var i = 0; i < jsonData.length; i++) {
									record.push({
										empId: jsonData[i].groupMemberId,
										groupId: jsonData[i].groupId,
										msgType: jsonData[i].msgType,
										content: jsonData[i].content,
										logo: '../images/logo.png'
									});
								}
								bindMsgList();
								console.log(JSON.stringify(jsonData));
							},
							error: function(XMLHttpRequest, textStatus, errorThrown) {
								console.log(XMLHttpRequest.status);
								console.log(XMLHttpRequest.readyState);
								console.log(textStatus);
							}
						});
					}
					var sendMsg = function sendMsg(record) {
						mui.ajax({
							url: getBaseServerUrl() + '/app/chatGroup/sendMessage',
							dataType: 'json',
							contentType: "application/json",
							data: JSON.stringify(record),
							type: 'post',
							success: function(jsonData) {
								console.log(JSON.stringify(jsonData));
							},
							error: function(XMLHttpRequest, textStatus, errorThrown) {
								console.log(XMLHttpRequest.status);
								console.log(XMLHttpRequest.readyState);
								console.log(textStatus);
							}
						});
					}
					var imageViewer = new mui.ImageViewer('.msg-content-image', {
						dbl: false
					});

					var bindMsgList = function() {
						chatListVM.dataArr = record;
						setTimeout(setImageView, 100)
					};

					function setImageView() {
						var msgItems = ui.areaMsgList.querySelectorAll('.msg-item');
						[].forEach.call(msgItems, function(item, index) {
							item.addEventListener('tap', function(event) {
								msgItemTap(item, event);
							}, false);
						});
						imageViewer.findAllImage();
						ui.areaMsgList.scrollTop = ui.areaMsgList.scrollHeight + ui.areaMsgList.offsetHeight;
					}
					//初始化查询
					queryMsg();

					ui.h.style.width = ui.boxMsgText.offsetWidth + 'px';
					var footerPadding = ui.footer.offsetHeight - ui.boxMsgText.offsetHeight;
					var msgItemTap = function(msgItem, event) {
						var msgType = msgItem.getAttribute('msg-type');
						var msgContent = msgItem.getAttribute('msg-content')
						if(msgType == '20') {
							dataURL2Audio(msgContent, function(entry) {
								var toURL = entry.toURL();
								var player = plus.audio.createPlayer(toURL);
								var playState = msgItem.querySelector('.play-state');
								playState.innerText = '正在播放...';
								player.play(function() {
									playState.innerText = '点击播放';
								}, function(e) {
									playState.innerText = '点击播放';
								});
							})
						}
					};

					window.addEventListener('resize', function() {
						ui.areaMsgList.scrollTop = ui.areaMsgList.scrollHeight + ui.areaMsgList.offsetHeight;
					}, false);
					var send = function(msg) {
						record.push(msg);
						bindMsgList();
						sendMsg(msg);
						//toRobot(msg.content);
					};
					//发送消息
					var toRobot = function(info) {
						var apiUrl = 'http://www.tuling123.com/openapi/api';
						mui.getJSON(apiUrl, {
							"key": 'acfbca724ea1b5db96d2eef88ce677dc',
							"info": info,
							"userid": plus.device.uuid
						}, function(data) {
							//alert(JSON.stringify(data));
							record.push({
								empId: 'zs',
								msgType: '10',
								content: data.text,
								logo: '../images/logo.png'
							});
							bindMsgList();
						});
					};

					function msgTextFocus() {
						ui.boxMsgText.focus();
						setTimeout(function() {
							ui.boxMsgText.focus();
						}, 150);
					}
					ui.buttonSpeech.addEventListener('release', function(event) {
						// 语音  mui-icon mui-icon-mic
						// 文本 mui-icon mui-icon-compose
						if(ui.btnMsgSpeech.classList.contains('mui-icon-mic')) { //切换语音
							ui.btnMsgSpeech.classList.add('mui-icon-compose');
							ui.btnMsgSpeech.classList.remove('mui-icon-mic');
							ui.boxMsgText.style.display = 'none';
							ui.boxMsgSound.style.display = 'block';
							ui.boxMsgText.blur();
							document.body.focus();
						} else if(ui.btnMsgSpeech.classList.contains('mui-icon-compose')) { //切换文本
							ui.btnMsgSpeech.classList.add('mui-icon-mic');
							ui.btnMsgSpeech.classList.remove('mui-icon-compose');
							ui.boxMsgSound.style.display = 'none';
							ui.boxMsgText.style.display = 'block';
						}
					}, false);
					ui.buttonAdd.addEventListener('release', function(event) {
						if(ui.btnMsgType.classList.contains('mui-icon-paperplane')) { //输入框有文字  发送
							send({
								empId: chatListVM.empId,
								groupId: chatListVM.groupId,
								msgType: '30',
								content: ui.boxMsgText.value.replace(new RegExp('\n', 'gm'), '<br/>')
							});
							ui.boxMsgText.value = '';
							mui.trigger(ui.boxMsgText, 'input', null);

						} else if(ui.btnMsgType.classList.contains('mui-icon-plus')) {
							ui.boxMsgText.blur();
							showAddBox();
						} else if(ui.btnMsgType.classList.contains('mui-icon-close')) {
							ui.boxMsgText.blur();
							hiddenAddBox();
						}
					}, false);

					var hiddenAddBox = function() {
						ui.addBox.style.display = 'none';
						ui.footer.style.bottom = '0px';
						ui.content.style.paddingBottom = ui.footer.offsetHeight + "px";
						ui.areaMsgList.scrollTop = ui.areaMsgList.scrollHeight + ui.areaMsgList.offsetHeight;
						ui.btnMsgType.classList.remove('mui-icon-close');
						ui.btnMsgType.classList.add('mui-icon-plus');
					}
					var showAddBox = function() {
						ui.addBox.style.display = 'block';
						ui.footer.style.bottom = ui.addBox.offsetHeight + "px";
						ui.content.style.paddingBottom = (ui.footer.offsetHeight + ui.addBox.offsetHeight) + "px";
						ui.areaMsgList.scrollTop = ui.areaMsgList.scrollHeight + ui.areaMsgList.offsetHeight;
						ui.btnMsgType.classList.add('mui-icon-close');
						ui.btnMsgType.classList.remove('mui-icon-plus');
					}

					//拍照
					ui.cameraBtn.addEventListener('tap', function(event) {
						hiddenAddBox();
						var cmr = plus.camera.getCamera();
						cmr.captureImage(function(path) {
							toBase64("file://" + plus.io.convertLocalFileSystemURL(path));
						}, function(err) {});
					}, false)

					//相册
					ui.galleryBtn.addEventListener('tap', function(event) {
						hiddenAddBox();
						plus.gallery.pick(function(path) {
							console.log(path);
							toBase64(path);

						}, function(err) {}, null);
					}, false);

					var setSoundAlertVisable = function(show) {
						if(show) {
							ui.boxSoundAlert.style.display = 'block';
							ui.boxSoundAlert.style.opacity = 1;
						} else {
							ui.boxSoundAlert.style.opacity = 0;
							//fadeOut 完成再真正隐藏
							setTimeout(function() {
								ui.boxSoundAlert.style.display = 'none';
							}, 200);
						}
					};
					var recordCancel = false;
					var recorder = null;
					var audio_tips = document.getElementById("audio_tips");
					var startTimestamp = null;
					var stopTimestamp = null;
					var stopTimer = null;
					//开始语音
					ui.boxMsgSound.addEventListener('hold', function(event) {
						recordCancel = false;
						if(stopTimer) clearTimeout(stopTimer);
						audio_tips.innerHTML = "手指上划，取消发送";
						ui.boxSoundAlert.classList.remove('rprogress-sigh');
						setSoundAlertVisable(true);
						recorder = plus.audio.getRecorder();
						if(recorder == null) {
							plus.nativeUI.toast("不能获取录音对象");
							return;
						}
						startTimestamp = (new Date()).getTime();
						recorder.record({
							filename: "_doc/audio/",
							format:"amr" 
						}, function(path) {
							if(recordCancel) return;
							Audio2dataURL(path);
						}, function(e) {
							plus.nativeUI.toast("录音时出现异常: " + e.message);
						});
					}, false);

					var Audio2dataURL = function(path) {
						plus.io.resolveLocalFileSystemURL(path, function(entry) {
							entry.file(function(file) {
								var reader = new plus.io.FileReader();
								reader.onloadend = function(e) {
									send({
										empId: chatListVM.empId,
										groupId: chatListVM.groupId,
										msgType: '20',
										content: e.target.result
									});
								};
								reader.readAsDataURL(file);
							}, function(e) {
								mui.toast("读写出现异常: " + e.message);
							})
						})
					}

					var dataURL2Audio = function(base64Str, callback) {
						var base64Str = base64Str.replace('data:audio/amr;base64,', '');
						var audioName =  "_doc/audio/" + (new Date()).valueOf() + '.amr';
						plus.io.requestFileSystem(plus.io.PRIVATE_DOC, function(fs) {
							fs.root.getFile(audioName, {
								create: true
							}, function(entry) {
								// 获得平台绝对路径
								var fullPath = entry.fullPath;
								if(mui.os.android) {
									// 读取音频
									var Base64 = plus.android.importClass("android.util.Base64");
									var FileOutputStream = plus.android.importClass("java.io.FileOutputStream");
									try {
										var out = new FileOutputStream(fullPath);
										var bytes = Base64.decode(base64Str, Base64.DEFAULT);
										out.write(bytes);
										out.close();
										// 回调
										callback && callback(entry);
									} catch(e) {
										console.log(e.message);
									}
								} else if(mui.os.ios) {
									var NSData = plus.ios.importClass('NSData');
									var nsData = new NSData();
									nsData = nsData.initWithBase64EncodedStringoptions(base64Str, 0);
									if(nsData) {
										nsData.plusCallMethod({
											writeToFile: fullPath,
											atomically: true
										});
										plus.ios.deleteObject(nsData);
									}
									// 回调
									callback && callback(entry);
								}
							},function(e){
								console.log(e.message);
							})
						})
					}

					ui.body.addEventListener('drag', function(event) {
						//console.log('drag');
						if(Math.abs(event.detail.deltaY) > 50) {
							if(!recordCancel) {
								recordCancel = true;
								if(!audio_tips.classList.contains("cancel")) {
									audio_tips.classList.add("cancel");
								}
								audio_tips.innerHTML = "松开手指，取消发送";
							}
						} else {
							if(recordCancel) {
								recordCancel = false;
								if(audio_tips.classList.contains("cancel")) {
									audio_tips.classList.remove("cancel");
								}
								audio_tips.innerHTML = "手指上划，取消发送";
							}
						}
					}, false);
					//结束语音
					ui.boxMsgSound.addEventListener('release', function(event) {
						//console.log('release');
						if(audio_tips.classList.contains("cancel")) {
							audio_tips.classList.remove("cancel");
							audio_tips.innerHTML = "手指上划，取消发送";
						}
						//
						stopTimestamp = (new Date()).getTime();
						if(stopTimestamp - startTimestamp < MIN_SOUND_TIME) {
							audio_tips.innerHTML = "录音时间太短";
							ui.boxSoundAlert.classList.add('rprogress-sigh');
							recordCancel = true;
							stopTimer = setTimeout(function() {
								setSoundAlertVisable(false);
							}, 800);
						} else {
							setSoundAlertVisable(false);
						}
						recorder.stop();
					}, false);
					ui.boxMsgSound.addEventListener("touchstart", function(e) {
						//console.log("start....");
						e.preventDefault();
					});

					//输入
					ui.boxMsgText.addEventListener('input', function(event) {
						ui.btnMsgType.classList[ui.boxMsgText.value == '' ? 'remove' : 'add']('mui-icon-paperplane');
						ui.btnMsgType.classList[ui.boxMsgText.value == '' ? 'add' : 'remove']('mui-icon-plus');
						ui.btnMsgType.setAttribute("for", ui.boxMsgText.value == '' ? '' : 'msg-text');
						ui.h.innerText = ui.boxMsgText.value.replace(new RegExp('\n', 'gm'), '\n-') || '-';
						ui.footer.style.height = (ui.h.offsetHeight + footerPadding) + 'px';
						ui.content.style.paddingBottom = ui.footer.style.height;
						if(ui.addBox.style.display == 'block') {
							hiddenAddBox();
						}
					});
					var focus = false;
					ui.boxMsgText.addEventListener('tap', function(event) {
						ui.boxMsgText.focus();
						setTimeout(function() {
							ui.boxMsgText.focus();
						}, 0);
						focus = true;
						setTimeout(function() {
							focus = false;
						}, 1000);
						if(ui.addBox.style.display == 'block') {
							hiddenAddBox();
						}
						event.detail.gesture.preventDefault();
					}, false);
					//点击消息列表，关闭键盘
					ui.areaMsgList.addEventListener('click', function(event) {
						if(!focus) {
							ui.boxMsgText.blur();
						}
					})

					//键盘弹出调整高度
					plus.webview.currentWebview().setStyle({
						softinputMode: "adjustResize"
					});
					var showKeyboard = function() {
						if(mui.os.ios) {
							var webView = plus.webview.currentWebview().nativeInstanceObject();
							webView.plusCallMethod({
								"setKeyboardDisplayRequiresUserAction": false
							});
						} else {
							var Context = plus.android.importClass("android.content.Context");
							var InputMethodManager = plus.android.importClass("android.view.inputmethod.InputMethodManager");
							var main = plus.android.runtimeMainActivity();
							var imm = main.getSystemService(Context.INPUT_METHOD_SERVICE);
							imm.toggleSoftInput(0, InputMethodManager.SHOW_FORCED);
							//var view = ((ViewGroup)main.findViewById(android.R.id.content)).getChildAt(0);
							imm.showSoftInput(main.getWindow().getDecorView(), InputMethodManager.SHOW_IMPLICIT);
							//alert("ll");
						}
					};

					var toBase64 = function(path) {
						console.log(path);
						var img = new Image();
						img.src = path; // 传过来的图片路径在这里用。
						img.onload = function() {
							var that = this;
							var quity = 0.4;
							var w = that.width,
								h = that.height,
								scale = w / h;
							w = 500;
							h = w / scale;
							var canvas = document.createElement('canvas');
							var ctx = canvas.getContext('2d');
							$(canvas).attr({
								width: w,
								height: h
							});
							ctx.drawImage(that, 0, 0, w, h);
							var base64 = canvas.toDataURL('image/jpeg', quity);
							var result = {
								base64: base64,
								clearBase64: base64.substr(base64.indexOf(',') + 1)
							};
							send({
								empId: chatListVM.empId,
								groupId: chatListVM.groupId,
								msgType: '30',
								content: base64
							});
						}
					}
				});
			}(mui, document));
		</script>
	</body>

</html>