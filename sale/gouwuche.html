<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>安装评价</title>
		<!-- Mobile Devices Support @begin -->
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
		<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
		<meta content="yes" name="apple-mobile-web-app-capable">
		<meta content="yes" name="apple-touch-fullscreen">
		<meta content="telephone=no,email=no" name="format-detection">
		<script src="../js/flexible.js" type="text/javascript"></script>
		<script src="../js/flexible_css.js" type="text/javascript"></script>
		<!-- Mobile Devices Support @end -->
		<link rel="stylesheet" href="../css/base-reset.css">
		<link rel="stylesheet" href="../css/mui.min.css">
		<link rel="stylesheet" type="text/css" href="../css/swiper-3.3.1.min.css">
		<link href="../picker/mui.picker.min.css" rel="stylesheet" />
		<link href="../picker/mui.poppicker.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../css/common.css">
		<link rel="stylesheet" type="text/css" href="../css/yhn.css">
	</head>
	<style>
		p{margin:0;}
		.header-right{top:0 !important;left:2.8rem !important}
		.gouwuche-top{overflow:hidden;margin:0;}
		.gouwuche-top>p{width:49.9%;height:1.2rem;line-height:1.2rem;border-right:1px solid #ddd;float:left;padding:0 .6rem;background:url(../images/icon-jiantou.png) no-repeat right;background-size:.3rem .4rem;background-position: 4.5rem .4rem;background-color: #fff;}
		.gouwuche-top>p:first-child{border-right:1px solid #ddd;color:#333}
		.gouwuche-top>p>span{float:right;color:#aaa}
		
		
		
		.mui-navigate-right {
			font-size: .4rem
		}
		
		.mui-navigate-right>span {
			margin-right: .5rem;
			font-size: .4rem;
			color: #aaa
		}
		
		.mui-navigate-right>input {
			margin-right: .5rem;
			font-size: .4rem;
			border:none;
			width:1.6rem;
			margin-top:.1rem
		}
		
		.mui-navigate-right>.active {
			color: #333
		}
		.mui-btn-blue{background-color:#EB6D00 !important;border:1px solid #EB6D00 !important}
		
		
		.gwc-table tr>td{height:.8rem;line-height:.8rem;background:#fff;font-size:.4rem;}
		.gwc-table tr>td:first-child{color:#aaa;width:4rem;padding-left:.4rem}
		.gwc-table tr>td:last-child{color:#333;width:6rem;}
		.gwc-table tr:last-child{border-bottom:1px solid #ddd}
		
		.gwc-btnGroup{height:1.2rem;}
		.gwc-btnGroup>div{width:33.33%;height:1.2rem;border-bottom:1px solid #ddd;float:left;background:#fff;overflow: hidden;}
		.gwc-btnGroup>div>div{width:1.6rem;height:.5rem;border-radius:.5rem;border:1px solid #666;color:#666;line-height:.5rem;text-align: center;margin:.4rem auto;}
		.gwc-btnGroup>div>div.active{border:1px solid #EA6D01;color:#EA6D01;}
		.gwc-btnGroup>div>div:active{background:#EA6D01;color:#fff;border:1px solid #EA6D01}
		
		.gwc-total>li{width:33.33%;float:left;height:1.2rem;text-align: center;line-height:1.2rem;font-size:.4rem;background:#fff}
		.gwc-total>li>strong{color:red;font-weight: bold;}
		.gwc-total>li>span{color:#999}
		
		
		.gwc-foot>div:first-child{width:6.8rem;height:1.2rem;background:#fff;float:left;line-height:1.2rem;text-align: right;padding-right:.4rem;font-size:.4rem;}
		.gwc-foot>div:first-child>b{color:red;}
		.gwc-foot>div:last-child{width:3.2rem;height:1.2rem;font-size:.4rem;line-height:1.2rem;text-align: center;color:#fff;background:#EA6D01;float:right;}
		.gwc-foot>div:active{opacity: .8;}
		.gwc-foot{
			position: absolute;bottom:0;left:0;right:0;
		}
		.under-top {
		    bottom:1.2rem;
		    margin-top: 0;
		}
		.mui-btn-blue{background-color:#EB6D00 !important;border:1px solid #EB6D00 !important}
		.price-box input{
			width:0.8rem;
			height:0.8rem;
			padding:0;margin:0;
			/*border:none;*/
			text-align: center;font-size: 0.32rem;

		}
		.gouwuche-msg .bcd{
			overflow:hidden;
			margin-bottom: 0.4rem;
		}
	</style>
	<body>
	<header class="mui-bar mui-bar-nav header">
		<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
		<span class="title">购物车({{dataArr.detail.length}})</span>
		<span id="gotoADD" @tap='gotoADD' class="header-right mui-icon mui-icon-plus"></span>
	</header>
	<section class=" g-content under-top">
		<div class="gouwuche-top">
			<p class='zhidanren'>制单人：<span>赵小五</span></p>
			<p class='jiazhuang-guwen'>家装顾问：<span>张小兰</span></p>
		</div>
		<p class="gwc-title">
			商品信息({{dataArr.detail.length}})
		</p>
		<div v-show='flag' class='abc gouwuche-edit'>
			<div class="addBox">
				<span></span>
				<h1>{{editPromsg.id}}/{{editPromsg.productName}}</h1>
				<div>
					<span></span>
					<div @tap='changeCount(-1)' class="y-sub-box">
						<img class="y-sd-icon" src="../images/icon-sub.png" alt="" />
					</div>
					<!-- <strong>{{editPromsg.qty}}</strong> -->
					<strong>{{m}}</strong>
					<div @tap='changeCount(1)' class="y-add-box">
						<img class="y-sd-add y-sd-icon" src="../images/icon-add.png" alt="" />
					</div>
				</div>
				<p>规格:{{editPromsg.productSpec}}</p>
			</div>

			<p class="gwc-title">
				销售价格 {{editPromsg.mprice}}
			</p>
			<div class="price-box">
				<div>
					<p>单价<span>(折后)</span></p>
					<p>¥<input type="number" v-model='salePrice' ></p>
				</div>
				<div>
					<p>折扣率</p>
					<p><input type="number" v-model='zhekoulv'></p>
				</div>
				<div>
					<p>小计：</p>
					<p><b>¥ {{salePrice * m }}</b></p>
				</div>
			</div>

			<ul class="mui-table-view" style="margin-top:.3rem">
				<li class="mui-table-view-cell">
					<a data-arr="arr1" data-index='{{editPromsg.deliverType}}' class="a-choice mui-navigate-right songhuo_sy">
						送货方式 
						<span class="right show_value0"></span>
					</a>
				</li>
				<li v-show='editPromsg.iscolor == 1' class="mui-table-view-cell">
					<a data-arr="arr2" class="a-choice mui-navigate-right">
					    色号:
						<input class="right" placeholder="输入色号" v-model="editPromsg.colorNum"></span>
					</a>
				</li>
				<li class="mui-table-view-cell">
					<a data-arr="arr2" data-date='{{editPromsg.deliverDate}}' class="a-choice mui-navigate-right startDate">
						发货日期
						<span class="right show_value2"></span>
					</a>
				</li>
			</ul>
			<div class="gwc-choice">
				<div>
					<span class="left">安装</span>
					<div @tap='switchInstall($event)' class="mui-switch mui-switch-mini" :class="{'mui-active':editPromsg.isInstall == 1}">
						<div class="mui-switch-handle"></div>
					</div>
				</div>
				<div>
					<span class="left">测量</span>
					<div @tap='switchMeasure($event)' class="mui-switch mui-switch-mini" :class="{'mui-active':editPromsg.isMeasure == 1}">
						<div class="mui-switch-handle"></div>
					</div>
				</div>
				<div>
					<span class="left">赠送</span>
					<div @tap='switchGiving($event)' class="mui-switch mui-switch-mini" :class="{'mui-active':editPromsg.isGiving == 1}">
						<div class="mui-switch-handle"></div>
					</div>
				</div>
			</div>

			<ul class="mui-table-view" style="margin-top:.3rem">
				<li class="mui-table-view-cell">
					<a data-arr="arr2" class="a-choice mui-navigate-right">
						<input style="width:6rem" class="right" placeholder="说点什么吧" v-model='saysomething'>备注</span>
					</a>
				</li>
			</ul>

			<div style="background:#fff;padding:.2rem 0;">
				<div @tap='done' class="y-btn" style="margin:0 auto;">
					完成
				</div>
			</div>
		</div>
        <div v-else class="gouwuche-msg">
			<div class="bcd gouwuche-msg" v-for="(index,key) in dataArr.detail">
				<div class="addBox">
					<span></span>
					<h1>{{key.id}}/{{key.productName}}</h1>
					<h2 @tap='bianji(key,index)' class="bianji">编辑</h2>
					<p>规格:{{key.productSpec}}</p>
					<h3 style="border-bottom:1px solid #ddd;margin-top:.5rem;"></h3>
				</div>

				<div class="gwc-table">
					<table>
						<tr>
							<td>送货方式：</td>
							<td>{{key.deliverType | formatdeliverType}}</td>
						</tr>
						<tr v-show="key.isColor==1">
							<td>色号：</td>
							<td>{{key.colorNum}}</td>
						</tr>
						<tr>
							<td>发货日期：</td>
							<td>{{key.deliverDate}}</td>
						</tr>
					</table>
				</div>

				<div class="gwc-btnGroup">
					<div>
						<div :class="{'active':key.isInstall == 1}">安装</div>
					</div>
					<div>
						<div :class="{'active':key.isMeasure == 1}">测量</div>
					</div>
					<div>
						<div :class="{'active':key.isGiving == 1}">赠送</div>
					</div>
				</div>

				<ul class="mui-table-view" style="margin-top:.3rem">
					<li class="mui-table-view-cell">
						<a data-arr="arr2" class="a-choice mui-navigate-right">
							<input style="width:6rem" readonly class="right" value="{{key.remark}}">备注</span>
						</a>
					</li>
				</ul>

				<ul class="gwc-total">
					<li>¥{{key.price}} <span>x{{key.qty}}</span></li>
					<li><span>折扣率:</span>{{key.discount}}</li>
					<li>小计: <strong>¥{{key.price*key.qty}}</strong></li>
				</ul>

			</div>
		</div>
	</section>

	<footer v-show='!flag' class="gwc-foot">
		<div>总计：<b>¥{{totalMoney}}</b></div>
		<div id="nextPage">下一步</div>
	</footer>

</body>
	<script src="../js/zepto1.1.6.min.js" type="text/javascript"></script>
	<script src='../js/mui.min.js'></script>
	<script type="text/javascript" src="../js/public.js"></script>
	<script type="text/javascript" src="../js/global.js"></script>
	<script type="text/javascript" src="../js/vue.min.js"></script>
	<script type="text/javascript" src="../picker/mui.picker.min.js"></script>
    <script type="text/javascript" src="../picker/mui.poppicker.js"></script>
	<script>
		var type1=localStorage.yhnjzOrls;
		var title1=null;
		var typeNum=null;
		if(type1=="jzxd"){
			title1="家装下单";
			typeNum="10";
		}else{
			title1="零售下单";
			typeNum="20";
		}

		mui.init({
				swipeBack:true //启用右滑关闭功能
		});

		mui('.mui-content .mui-switch').each(function() { //循环所有toggle
				//toggle.classList.contains('mui-active') 可识别该toggle的开关状态
				this.parentNode.querySelector('span').innerText = '状态：' + (this.classList.contains('mui-active') ? 'true' : 'false');
				/**
				 * toggle 事件监听
				 */
				this.addEventListener('toggle', function(event) {
					//event.detail.isActive 可直接获取当前状态
					this.parentNode.querySelector('span').innerText = '状态：' + (event.detail.isActive ? 'true' : 'false');
			    });
		});
        function picker(){
			(function($) {
				$.init();
				var now = new Date();
	            var optionsJson = '{"type":"date","beginYear":' + (now.getFullYear() - 1) + ',"endYear":' + (now.getFullYear() + 1) + '}';
				var options = JSON.parse(optionsJson);

	             
	            setTimeout(function(){
					var date=$('.under-top .startDate')[0].getAttribute('data-date');
				    $('.under-top .startDate .show_value2')[0].innerText=date;
			    },0)
			    $('.under-top .startDate .show_value2')[0].innerText = now.getFullYear() + "-" + formatMonth((now.getMonth() + 1).toString()) + "-" + formatMonth(now.getDate().toString());

				$('.under-top .startDate')[0].addEventListener('tap', function() {
					var picker = new $.DtPicker(options);
					picker.show(function(rs) {
						$('.under-top .startDate .show_value2')[0].innerText = rs.text;
						picker.dispose();
						deliverdate()
					});
				}, false);

				var arr = [{index:0,text:"自提"},{index:1,text:"配送"},{index:2,text:"厂送"}];

				// 默认是配送
				setTimeout(function(){
					var index=$('.under-top .songhuo_sy')[0].getAttribute('data-index');
				    $('.under-top .songhuo_sy .show_value0')[0].innerText=arr[index].text;
			    },0)
			
				$('.under-top .songhuo_sy')[0].addEventListener('tap', function() {
					var cardPicker = new $.PopPicker({
						layer: 1
					});
					cardPicker.setData(arr);
					cardPicker.show(function(items) {
						$('.under-top .songhuo_sy .show_value0')[0].innerText = items[0].text;
						$('.under-top .songhuo_sy')[0].setAttribute('data-index',items[0].index)
						cardPicker.dispose();
						deliverType()
					});
				}, false);
			})(mui);
		}

		(function($) {
				$.init();
                // 制单人数据
				var arr2 = [{index:0,text:"赵小五"},{index:1,text:"赵小五222"},{index:2,text:"赵小五33"}];
				$('.gouwuche-top .zhidanren')[0].addEventListener('tap', function() {
					var cardPicker = new $.PopPicker({
						layer: 1
					});
					cardPicker.setData(arr2);
					cardPicker.show(function(items) {
						$('.zhidanren span')[0].innerText = items[0].text;
						cardPicker.dispose();
					});
				}, false);

				$('.gouwuche-top .jiazhuang-guwen')[0].addEventListener('tap', function() {
					var cardPicker = new $.PopPicker({
						layer: 1
					});
					cardPicker.setData(arr2);
					cardPicker.show(function(items) {
						$('.jiazhuang-guwen span')[0].innerText = items[0].text;
						cardPicker.dispose();
					});
				}, false);

		})(mui);
		var data1=JSON.parse(localStorage.LZRproduMsg);
		
		 
		Vue.filter('formatdeliverType',function(value){
          if(value== 0){
          	return '自提'
          }
          else if(value == 1){
          	return '配送'
          }else{
          	return '厂送'
          }
	    });
		
		
		var vm=new Vue({
			el:"body",
			data:{
				dataArr:data1,
				flag:false,
				editPromsg:'',
				m:'',
				mprice:'',
				salePrice:'',
				zhekoulv:'',
				saysomething:'',
				editIndex:null
			},
			methods:{
				bianji(item,index){
                   this.flag=true;
                   this.editIndex=index;
                   this.editPromsg=item;
                   this.m=this.editPromsg.qty;
                   this.salePrice=this.editPromsg.price;
                   this.zhekoulv=this.editPromsg.discount;
                   this.mprice=this.editPromsg.mprice;
                   this.saysomething=this.editPromsg.remark;
                   console.log(JSON.stringify(this.editPromsg))
                   picker();
				},
				changeCount(m){
					if (m >= 1) {
						this.m++
					} else {
						if (this.m == 1) {
							this.m = 1;
						} else {
							this.m--;
						}
					}
					this.editPromsg.qty=this.m
				},
				switchInstall(e){
					 if( e.currentTarget.className.indexOf('active') > -1){
					 	this.editPromsg.isInstall=1;
					 }
					 else{
					 	this.editPromsg.isInstall=0;
					 }
				},
				switchMeasure(e){
					 if( e.currentTarget.className.indexOf('active') > -1){
					 	 this.editPromsg.isMeasure=1;
					 }
					 else{
					 	this.editPromsg.isMeasure=0;
					 }
				},
				switchGiving(e){
					 if( e.currentTarget.className.indexOf('active') > -1){
					 	 this.editPromsg.isGiving=1;
					 }
					 else{
					 	this.editPromsg.isGiving=0;
					 }
				},
				done(){
					var length=this.dataArr.detail.length;
					var index=this.editIndex

					var oldmsg=this.dataArr.detail[index];
					var newmsg=this.editPromsg;
					var pro_detail = Object.assign({},oldmsg,newmsg);

					this.dataArr.detail[index]=pro_detail;
					this.flag=false;

					localStorage.LZRproduMsg=JSON.stringify(this.dataArr)
				},
				gotoADD(){
					openNew("add-shangpin.html");
				}
			},
			watch:{
				salePrice: function() {
					if (this.salePrice <= this.mprice) {
						var zhekoulv = this.salePrice / this.mprice;
						this.zhekoulv = zhekoulv;
					} else {
						this.salePrice = this.mprice
					}
					this.editPromsg.price=this.salePrice;
				},
				zhekoulv: function() {
					if (this.zhekoulv > 1 || this.zhekoulv <= 0) {
						this.zhekoulv = 1;
					} else {
						var salePrice = this.zhekoulv * this.mprice;
						this.salePrice = salePrice
					}
					this.editPromsg.discount=this.zhekoulv;
				},
				saysomething:function(){
					this.editPromsg.remark=this.saysomething;
				}
			},
			computed:{
				totalMoney:function(){
					var arr=this.dataArr.detail;
					var length=arr.length;
					var totalprice=0
					for(var i=0;i<length;i++){
                      totalprice += ( arr[i].price * arr[i].qty )
					}
					return totalprice
				}
			},
			ready(){
			}
		});

		function formatMonth(month) {
			if(month.length == 1) {
				return "0" + month;
			}
			return month;
		}

		function deliverType(){
			var deliverType_index=$('.under-top .songhuo_sy').data('index');
			vm.editPromsg.deliverType=deliverType_index;
		}
		function deliverdate(){
			var deliverDate=$('.under-top .startDate .show_value2').html();
 		    vm.editPromsg.deliverDate=deliverDate;
		}
		 
		$("#nextPage").on("tap",function(){
			
		 	localStorage.LZRproduMsg=JSON.stringify(vm.dataArr);
		 	if(type1=="jzxd"){
		 		openNew("xuanze-jiaz_kehu.html");
			}else{
				openNew("shouhuo-xinxi.html");
			}
		});
		
		
		function init(){
			var data=JSON.parse(localStorage.LZRproduMsg);
			vm.dataArr=data;
		}
	</script>
</html>
